<!-- change_password.html - Password change form -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Change Password - POS System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
</head>
<body>
    
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header {{ 'bg-warning' if is_first_time else 'bg-primary' }} text-white">
                        <h4 class="mb-0">
                            <i class="bi bi-shield-lock"></i> 
                            {{ 'Set New Password' if is_first_time else 'Change Password' }}
                        </h4>
                    </div>
                    <div class="card-body">
                        {% if is_first_time %}
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i>
                                <strong>Welcome!</strong> You must change your temporary password before you can use the system.
                            </div>
                        {% endif %}
                        
                        <form method="POST" novalidate>
                            {{ form.hidden_tag() }}
                            
                            {% if is_first_time %}
                                <!-- First-time password change -->
                                <div class="mb-3">
                                    {{ form.username.label(class="form-label") }}
                                    {{ form.username(class="form-control", readonly=true) }}
                                </div>
                                
                                <div class="mb-3">
                                    {{ form.temporary_password.label(class="form-label") }}
                                    {{ form.temporary_password(class="form-control" + (" is-invalid" if form.temporary_password.errors else "")) }}
                                    {% if form.temporary_password.errors %}
                                        <div class="invalid-feedback">
                                            {% for error in form.temporary_password.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                    <div class="form-text">Enter the temporary password provided to you</div>
                                </div>
                            {% else %}
                                <!-- Regular password change -->
                                <div class="mb-3">
                                    {{ form.current_password.label(class="form-label") }}
                                    {{ form.current_password(class="form-control" + (" is-invalid" if form.current_password.errors else "")) }}
                                    {% if form.current_password.errors %}
                                        <div class="invalid-feedback">
                                            {% for error in form.current_password.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            {% endif %}
                            
                            <div class="mb-3">
                                {{ form.new_password.label(class="form-label") }}
                                {{ form.new_password(class="form-control" + (" is-invalid" if form.new_password.errors else ""), id="newPassword") }}
                                {% if form.new_password.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.new_password.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <div class="form-text">
                                    Password must be at least 8 characters long
                                </div>
                                <div class="progress mt-2" style="height: 5px;">
                                    <div class="progress-bar" id="passwordStrength" role="progressbar" style="width: 0%"></div>
                                </div>
                                <small id="strengthText" class="form-text"></small>
                            </div>
                            
                            <div class="mb-3">
                                {{ form.confirm_password.label(class="form-label") }}
                                {{ form.confirm_password(class="form-control" + (" is-invalid" if form.confirm_password.errors else ""), id="confirmPassword") }}
                                {% if form.confirm_password.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.confirm_password.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <div id="passwordMatch" class="form-text"></div>
                            </div>
                            
                            <div class="d-grid">
                                {{ form.submit(class="btn btn-" + ("warning" if is_first_time else "primary") + " btn-lg") }}
                            </div>
                        </form>
                        
                        {% if not is_first_time %}
                            <div class="text-center mt-3">
                                <a href="{{ url_for('main.index') }}" class="btn btn-outline-secondary">
                                    Cancel
                                </a>
                            </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Password Requirements Card -->
                <div class="card mt-4">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="bi bi-shield-check"></i> Password Requirements</h6>
                    </div>
                    <div class="card-body">
                        <ul class="list-unstyled mb-0">
                            <li><i class="bi bi-check-circle text-muted" id="req-length"></i> At least 8 characters long</li>
                            <li><i class="bi bi-check-circle text-muted" id="req-upper"></i> At least one uppercase letter</li>
                            <li><i class="bi bi-check-circle text-muted" id="req-lower"></i> At least one lowercase letter</li>
                            <li><i class="bi bi-check-circle text-muted" id="req-number"></i> At least one number</li>
                            <li><i class="bi bi-check-circle text-muted" id="req-special"></i> At least one special character</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const newPassword = document.getElementById('newPassword');
            const confirmPassword = document.getElementById('confirmPassword');
            const strengthBar = document.getElementById('passwordStrength');
            const strengthText = document.getElementById('strengthText');
            const passwordMatch = document.getElementById('passwordMatch');
            
            // Password strength checker
            newPassword.addEventListener('input', function() {
                const password = this.value;
                const strength = checkPasswordStrength(password);
                
                // Update strength bar
                strengthBar.style.width = strength.score + '%';
                strengthBar.className = 'progress-bar ' + strength.class;
                strengthText.textContent = strength.text;
                strengthText.className = 'form-text ' + strength.textClass;
                
                // Update requirements
                updateRequirements(password);
                
                // Check password match
                checkPasswordMatch();
            });
            
            confirmPassword.addEventListener('input', checkPasswordMatch);
            
            function checkPasswordStrength(password) {
                let score = 0;
                let feedback = [];
                
                if (password.length >= 8) score += 20;
                if (password.match(/[a-z]/)) score += 20;
                if (password.match(/[A-Z]/)) score += 20;
                if (password.match(/[0-9]/)) score += 20;
                if (password.match(/[^A-Za-z0-9]/)) score += 20;
                
                let strength = '';
                let className = '';
                let textClass = '';
                
                if (score < 40) {
                    strength = 'Weak';
                    className = 'bg-danger';
                    textClass = 'text-danger';
                } else if (score < 80) {
                    strength = 'Medium';
                    className = 'bg-warning';
                    textClass = 'text-warning';
                } else {
                    strength = 'Strong';
                    className = 'bg-success';
                    textClass = 'text-success';
                }
                
                return {
                    score: score,
                    text: strength,
                    class: className,
                    textClass: textClass
                };
            }
            
            function updateRequirements(password) {
                const requirements = [
                    { id: 'req-length', test: password.length >= 8 },
                    { id: 'req-upper', test: /[A-Z]/.test(password) },
                    { id: 'req-lower', test: /[a-z]/.test(password) },
                    { id: 'req-number', test: /[0-9]/.test(password) },
                    { id: 'req-special', test: /[^A-Za-z0-9]/.test(password) }
                ];
                
                requirements.forEach(req => {
                    const element = document.getElementById(req.id);
                    if (req.test) {
                        element.className = 'bi bi-check-circle-fill text-success';
                    } else {
                        element.className = 'bi bi-check-circle text-muted';
                    }
                });
            }
            
            function checkPasswordMatch() {
                const newPwd = newPassword.value;
                const confirmPwd = confirmPassword.value;
                
                if (confirmPwd === '') {
                    passwordMatch.textContent = '';
                    passwordMatch.className = 'form-text';
                    return;
                }
                
                if (newPwd === confirmPwd) {
                    passwordMatch.textContent = '✓ Passwords match';
                    passwordMatch.className = 'form-text text-success';
                } else {
                    passwordMatch.textContent = '✗ Passwords do not match';
                    passwordMatch.className = 'form-text text-danger';
                }
            }
        });
    </script>
</body>
</html>