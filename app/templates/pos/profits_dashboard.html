<!DOCTYPE html>
<html>
<head>
    <title>Profits Dashboard - MY LORD ENTERPRISE POS SYSTEM</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container-fluid mt-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <h2><i class="bi bi-graph-up"></i> Profits Dashboard</h2>
                    <div class="d-flex gap-2">
                        <a href="/pos/sales-report" class="btn btn-outline-primary">
                            <i class="bi bi-bar-chart"></i> Sales Report
                        </a>
                        <a href="/pos/list-sales" class="btn btn-outline-secondary">
                            <i class="bi bi-list"></i> Sales List
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Date Filter -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <form method="GET" class="row g-3 align-items-end">
                            <div class="col-md-2">
                                <label for="start_date" class="form-label">Start Date</label>
                                <input type="date" class="form-control" id="start_date" name="start_date" 
                                       value="{{ start_date }}">
                            </div>
                            <div class="col-md-2">
                                <label for="end_date" class="form-label">End Date</label>
                                <input type="date" class="form-control" id="end_date" name="end_date" 
                                       value="{{ end_date }}">
                            </div>
                            <div class="col-md-2">
                                <label for="period" class="form-label">Quick Period</label>
                                <select class="form-select" id="period" name="period">
                                    <option value="7" {{ 'selected' if period == '7' else '' }}>Last 7 days</option>
                                    <option value="30" {{ 'selected' if period == '30' else '' }}>Last 30 days</option>
                                    <option value="90" {{ 'selected' if period == '90' else '' }}>Last 3 months</option>
                                    <option value="365" {{ 'selected' if period == '365' else '' }}>Last year</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-search"></i> Update
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Key Metrics -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-white bg-success">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title">Total Revenue</h6>
                                <h4>GHS {{ "%.2f"|format(total_revenue) }}</h4>
                            </div>
                            <i class="bi bi-currency-dollar" style="font-size: 2rem; opacity: 0.7;"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-primary">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title">Total Profit</h6>
                                <h4>GHS {{ "%.2f"|format(total_profit) }}</h4>
                            </div>
                            <i class="bi bi-graph-up" style="font-size: 2rem; opacity: 0.7;"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-info">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title">Profit Margin</h6>
                                <h4>{{ "%.1f"|format(profit_margin) }}%</h4>
                            </div>
                            <i class="bi bi-percent" style="font-size: 2rem; opacity: 0.7;"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-dark">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title">Total Sales</h6>
                                <h4>{{ total_sales_count }}</h4>
                            </div>
                            <i class="bi bi-receipt" style="font-size: 2rem; opacity: 0.7;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5>Daily Profit Trend</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="dailyProfitChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5>Profit by Unit Type</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="unitProfitChart" width="300" height="300"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Top Products by Profit -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Top 10 Products by Profit</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Product</th>
                                        <th>SKU</th>
                                        <th class="text-center">Qty Sold</th>
                                        <th class="text-end">Revenue</th>
                                        <th class="text-end">Profit</th>
                                        <th class="text-end">Profit Margin</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for product in product_profits %}
                                    <tr>
                                        <td><strong>{{ product.product_name }}</strong></td>
                                        <td><code>{{ product.sku }}</code></td>
                                        <td class="text-center">{{ product.quantity_sold }}</td>
                                        <td class="text-end">GHS {{ "%.2f"|format(product.total_revenue) }}</td>
                                        <td class="text-end text-success">
                                            <strong>GHS {{ "%.2f"|format(product.total_profit) }}</strong>
                                        </td>
                                        <td class="text-end">
                                            {{ "%.1f"|format((product.total_profit / product.total_revenue * 100) if product.total_revenue > 0 else 0) }}%
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Unit Type Breakdown -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Profit Breakdown by Unit Type</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            {% for unit in unit_profits %}
                            <div class="col-md-4">
                                <div class="border rounded p-3 mb-3">
                                    <h6 class="text-primary">
                                        {% if unit.unit_type == 'full' %}
                                            <i class="bi bi-box"></i> Full Pack
                                        {% elif unit.unit_type == 'half' %}
                                            <i class="bi bi-box-seam"></i> Half Pack
                                        {% else %}
                                            <i class="bi bi-box-arrow-down"></i> Quarter Pack
                                        {% endif %}
                                    </h6>
                                    <p class="mb-1"><strong>Units Sold:</strong> {{ unit.quantity_sold }}</p>
                                    <p class="mb-1"><strong>Revenue:</strong> GHS {{ "%.2f"|format(unit.total_revenue) }}</p>
                                    <p class="mb-0 text-success"><strong>Profit:</strong> GHS {{ "%.2f"|format(unit.total_profit) }}</p>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Daily Profit Chart - FIXED: Handle the corrected data structure
        const dailyCtx = document.getElementById('dailyProfitChart').getContext('2d');
        const dailyProfitChart = new Chart(dailyCtx, {
            type: 'line',
            data: {
                labels: [
                    {% for day in daily_profits %}
                        "{{ day.date.strftime('%m/%d') if day.date else 'N/A' }}"{% if not loop.last %},{% endif %}
                    {% endfor %}
                ],
                datasets: [{
                    label: 'Daily Profit (GHS)',
                    data: [
                        {% for day in daily_profits %}
                        {{ day.profit|float if day.profit else 0 }}{% if not loop.last %},{% endif %}
                        {% endfor %}
                    ],
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.1,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return 'GHS ' + value.toFixed(2);
                            }
                        }
                    }
                }
            }
        });

        // Unit Type Profit Pie Chart
        const unitCtx = document.getElementById('unitProfitChart').getContext('2d');
        const unitProfitChart = new Chart(unitCtx, {
            type: 'doughnut',
            data: {
                labels: [
                    {% for unit in unit_profits %}
                    '{{ unit.unit_type.title() }} Pack'{% if not loop.last %},{% endif %}
                    {% endfor %}
                ],
                datasets: [{
                    data: [
                        {% for unit in unit_profits %}
                        {{ unit.total_profit|float if unit.total_profit else 0 }}{% if not loop.last %},{% endif %}
                        {% endfor %}
                    ],
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.8)',
                        'rgba(54, 162, 235, 0.8)',
                        'rgba(255, 205, 86, 0.8)'
                    ]
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.label + ': GHS ' + context.parsed.toFixed(2);
                            }
                        }
                    }
                }
            }
        });
    </script>
</body>
</html>